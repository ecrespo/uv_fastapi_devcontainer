# uv_fastapi_devcontainer


1. Install uv package manager

```bash
pipx install uv 
```

2. Inicializando el entorno
```bash
uv init . 
```
3. Crea el archivo pyproject.toml

```
[project]
name = "uv-fastapi-devcontainer"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.12"
dependencies = []
```


4. Crear un entorno .venv
```
uv venv
Using Python 3.12.3 interpreter at: /usr/bin/python3.12
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
```

5. Activar  el entorno:
```aiignore
source .venv/bin/activate
```

6. . INstalar uvicorn y fastapi

```bash 
uv add fastapi uvicorn
```

Esto genera el archivo uv.lock 

Y ahora el archivo pyproject.toml contiene los paquetes:
```aiignore

[project]
name = "uv-fastapi-devcontainer"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.12"
dependencies = [
    "fastapi>=0.115.0",
    "uvicorn>=0.30.6",
]

```

7. Se puede generar un archivo requirements.txt a partir del pyproject.toml

```aiignore
uv pip compile pyproject.toml -o requirements.txt
Resolved 12 packages in 602ms
# This file was autogenerated by uv via the following command:
#    uv pip compile pyproject.toml -o requirements.txt
annotated-types==0.7.0
    # via pydantic
anyio==4.6.0
    # via starlette
click==8.1.7
    # via uvicorn
fastapi==0.115.0
    # via uv-fastapi-devcontainer (pyproject.toml)
h11==0.14.0
    # via uvicorn
idna==3.10
    # via anyio
pydantic==2.9.2
    # via fastapi
pydantic-core==2.23.4
    # via pydantic
sniffio==1.3.1
    # via anyio
starlette==0.38.5
    # via fastapi
typing-extensions==4.12.2
    # via
    #   fastapi
    #   pydantic
    #   pydantic-core
uvicorn==0.30.6
    # via uv-fastapi-devcontainer (pyproject.toml)
```
8. Probar que el entorno se ejecuta

```bash 
uv run python3 run.py 
Installed 12 packages in 13ms
INFO:     Will watch for changes in these directories: ['/home/ernesto/PycharmProjects/uv_fastapi_devcontainer']
WARNING:  "workers" flag is ignored when reloading is enabled.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [27866] using StatReload
INFO:     Started server process [27871]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

9. El archivo Dockerfile con soporte de uv para correr  fastapi.

```Dockerfile

# Use a Python image with uv pre-installed
# Primera etapa: compilación y creación de la aplicación
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim AS builder

# Configuración de entorno
ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy

# Directorio de trabajo para la aplicación
WORKDIR /app

# Montaje de caché para acelerar las instalaciones futuras y bind de los archivos necesarios
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --frozen --no-install-project --no-dev

# Agregamos el contenido de la aplicación
ADD . /app

# Copiamos los archivos necesarios
COPY app.py /app/
COPY run.py /app/

# Instalación de las dependencias necesarias
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev

# Segunda etapa: imagen final
FROM python:3.12-slim-bookworm

# Directorio de trabajo para la aplicación
WORKDIR /app

# Copiamos las dependencias instaladas desde la imagen "builder"
COPY --from=builder /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages

# Copia el directorio completo de la aplicación desde la imagen "builder"
COPY --from=builder /app /app

# Configuramos el PATH para incluir el virtual environment
ENV PATH="/app/.venv/bin:$PATH"

# Ejecuta la aplicación FastAPI de forma predeterminada
CMD ["python3", "run.py"]

```

10. Archivo docker-compose.yaml:

```YAML
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: app
    ports:
      - "8000:8000"
    networks:
      - fastapi_api
    restart: always
    develop:
      # Create a `watch` configuration to update the appl
      # https://docs.docker.com/compose/file-watch/#compose-watch-versus-bind-mounts
      watch:
        # Sync the working directory with the `/app` directory in the container
        - action: sync
          path: .
          target: /app
          # Exclude the project virtual environment — it could be for a
          # different platform in the container
          ignore:
            - .venv/

        # Rebuild the image on changes to the `pyproject.toml`
        - action: rebuild
          path: ./pyproject.toml

networks:
  fastapi_api:
    driver: bridge
```

11. Correr el proyecto:

```bash
docker compose up --build -d
```
